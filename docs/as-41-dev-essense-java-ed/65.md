65\. 安卓 SQLite 数据库概述

不需要存储至少一些持久数据的移动应用程序少之又少。数据库的使用是大多数应用程序的一个重要方面，从几乎完全由数据驱动的应用程序，到只需要存储少量数据(如游戏的主要分数)的应用程序。

考虑到典型安卓应用程序的短暂生命周期，持久数据存储的重要性变得更加明显。由于安卓运行时系统会终止应用程序组件以释放资源的风险一直存在，因此避免数据丢失的全面数据存储策略是任何应用程序开发策略设计和实施的关键因素。

本章将概述与 Android 操作系统捆绑在一起的 SQLite 数据库管理系统，以及 Android SDK 类的概述，提供这些类是为了从 Android 应用程序中促进基于 SQLite 的持久数据库存储。然而，在深入研究安卓开发环境中的 SQLite 细节之前，我们将简要概述一下数据库和 SQL。

65.1 理解数据库表

数据库表提供了数据库中最基本的数据结构。每个数据库可以包含多个表，每个表都被设计为保存特定类型的信息。例如，数据库可能包含一个客户表，其中包含特定企业的每个客户的姓名、地址和电话号码。同一数据库还可以包括用于存储产品描述的产品表，该产品描述带有企业销售的产品的相关产品代码。

数据库中的每个表都被分配了一个名称，该名称在特定的数据库中必须是唯一的。表名一旦分配给一个数据库中的表，就不能用于另一个表，除非在另一个数据库的上下文中。

65.2 介绍数据库模式

数据库模式定义了存储在数据库表中的数据的特征。例如，客户数据库表的表模式可能定义客户名称是长度不超过 20 个字符的字符串，客户电话号码是某种格式的数字数据字段。

模式还用于定义整个数据库的结构以及每个数据库中包含的各种表之间的关系。

65.3 列和数据类型

在此阶段，开始将数据库表视为类似于以行和列存储数据的电子表格是有帮助的。

每一列代表相应表中的一个数据字段。例如，表的名称、地址和电话数据字段都是列。

每个列又被定义为包含特定类型的数据。因此，用于存储数字的列将被定义为包含数字数据。

65.4 数据库行

保存到表中的每个新记录都存储在一行中。每行又由与保存的记录相关联的数据列组成。

再次考虑本章前面描述的电子表格类比。客户表中的每个条目相当于电子表格中的一行，每一列都包含每个客户的数据(姓名、地址、电话等)。将新客户添加到表中时，会创建一个新行，该客户的数据存储在新行的相应列中。

行有时也被称为记录或条目，这些术语通常可以互换使用。

65.5 介绍主键

每个数据库表应该包含一列或多列，用于唯一标识表中的每一行。这在数据库术语中称为主键。例如，表可以使用银行账号列作为主键。或者，客户表可以使用客户的社会保险号作为主键。

主键允许数据库管理系统唯一地标识表中的特定行。没有主键，就不可能检索或删除表中的特定行，因为无法确定是否选择了正确的行。例如，假设存在一个表，其中客户的姓氏被定义为主键。想象一下，如果数据库中记录了多个名为“史密斯”的客户，可能会出现什么问题。如果没有某种有保证的方法来唯一地标识特定的行，就不可能确保在任何给定的时间访问正确的数据。

主键可以包含表中的一列或多列。要符合单列主键的条件，任何两行都不能包含匹配的主键值。使用多列构造主键时，单个列值不需要唯一，但是所有列的值组合在一起必须唯一。

65.6 什么是 SQLite ？

SQLite 是一个嵌入式关系数据库管理系统(RDBMS)。大多数关系数据库(Oracle、SQL Server 和 MySQL 是主要示例)都是独立的服务器进程，它们独立运行，并与需要数据库访问的应用程序协作。SQLite 被称为嵌入式，因为它是以链接到应用程序的库的形式提供的。因此，没有独立的数据库服务器在后台运行。所有数据库操作都在应用程序内部通过调用 SQLite 库中包含的函数来处理。

SQLite 的开发人员已经将该技术放入了公共领域，因此它现在是一个广泛部署的数据库解决方案。

SQLite 是用 C 编程语言编写的，因此，Android SDK 为底层数据库接口提供了一个基于 Java 的“包装器”。这基本上由一组类组成，这些类可以在应用程序的 Java 或 Kotlin 代码中用来创建和管理基于 SQLite 的数据库。

关于 SQLite 的更多信息，请参考[https://www.sqlite.org](http://www.sqlite.org)。

65.7 结构化查询语言 (SQL )

在 SQLite 数据库中，使用一种称为结构化查询语言的高级语言来访问数据。这通常缩写为 SQL，发音为 sequel。SQL 是大多数关系数据库管理系统使用的标准语言。SQLite 大部分符合 SQL-92 标准。

SQL 本质上是一种非常简单且易于使用的语言，专门设计用于读取和写入数据库数据。因为 SQL 包含了一个小的关键字集，所以可以很快学会。此外，大多数数据库管理系统实现之间的 SQL 语法或多或少是相同的，因此，学习了一个系统的 SQL 后，您的技能很可能会转移到其他数据库管理系统。

虽然本章将使用一些基本的 SQL 语句，但是对 SQL 的详细概述超出了本书的范围。然而，还有许多其他资源提供了比我们在一章中所能提供的更好的 SQL 概述。

65.8 在安卓虚拟设备(AVD)上尝试 SQLite

对于不熟悉数据库，尤其是不熟悉 SQLite 的读者来说，直接创建一个使用 SQLite 的安卓应用程序似乎有点令人生畏。幸运的是，安卓系统预装了 SQLite，包括一个交互环境，用于从连接到运行中的安卓 AVD 仿真器实例的 adb shell 会话中发出 SQL 命令。这既是了解 SQLite 和 SQL 的有用方法，也是识别模拟器中运行的应用程序创建的数据库问题的宝贵工具。

要启动交互式 SQLite 会话，请从运行 AVD 会话开始。这可以通过在安卓工作室中启动安卓虚拟设备管理器(工具->自动增值设备管理器)，选择一个先前配置的自动增值设备并点击开始按钮来实现。

一旦 AVD 启动并运行，打开终端或命令提示符窗口，使用 adb 命令行工具连接到仿真器，如下所示(注意–e 标志指示工具寻找要连接的仿真器，而不是物理设备):

```
adb –e shell
```

一旦连接，shell 环境将提供一个命令提示符，在这里可以输入命令。首先使用 su 命令获得超级用户权限:

```
Generic_x86:/ su
root@android:/ #
```

如果出现一条消息，表明不允许超级用户权限，则很可能 AVD 实例包含 Google Play 支持。要解决此问题，请创建一个新的 AVD，并在“选择设备定义”屏幕上，选择一个在“播放存储”栏中没有标记的设备。

存储在 SQLite 数据库中的数据实际上存储在运行应用程序的安卓设备的文件系统上的数据库文件中。默认情况下，这些数据库文件的文件系统路径如下:

```
/data/data/<package name>/databases/<database filename>.db
```

例如，如果包名为 com.example.MyDBApp 的应用程序创建了一个名为 mydatabase.db 的数据库，设备上文件的路径将如下所示:

```
/data/data/com.example.MyDBApp/databases/mydatabase.db
```

因此，出于本练习的目的，请在 adb shell 中将目录更改为/data/data，并创建一个适用于某些 SQLite 实验的子目录层次结构:

```
cd /data/data
mkdir com.example.dbexample
cd com.example.dbexample
mkdir databases
cd databases
```

为数据库文件创建合适的位置后，按如下方式启动交互式 SQLite 工具:

```
root@android:/data/data/databases # sqlite3 ./mydatabase.db
sqlite3 ./mydatabase.db
SQLite version 3.8.10.2 2015-05-20 18:17:19
Enter ".help" for usage hints.
sqlite>
```

在 sqlite >提示符下，可以输入命令来执行创建表、插入和检索数据等任务。例如，要在我们的数据库中创建一个新表，其中的字段用于保存身份证、姓名、地址和电话号码字段，则需要以下语句:

```
create table contacts (_id integer primary key autoincrement, name text, address text, phone text);
```

请注意，表中的每一行都应该有一个对该行唯一的主键。在上面的示例中，我们将 ID 字段指定为主键，将其声明为整数类型，并要求 SQLite 在每次添加一行时自动增加该数字。这是确保每行都有唯一主键的常见方法。在大多数其他平台上，主键名称的选择是任意的。然而，在安卓的情况下，关键是命名为 _id，以便使用所有安卓数据库相关的类完全访问数据库。其余字段都声明为文本类型。

若要列出当前选定数据库中的表，请使用。tables 语句:

```
sqlite> .tables
contacts
```

要将记录插入表中:

```
sqlite> insert into contacts (name, address, phone) values ("Bill Smith", "123 Main Street, California", "123-555-2323");
sqlite> insert into contacts (name, address, phone) values ("Mike Parks", "10 Upping Street, Idaho", "444-444-1212");
```

要从表中检索所有行，请执行以下操作:

```
sqlite> select * from contacts;
1|Bill Smith|123 Main Street, California|123-555-2323
2|Mike Parks|10 Upping Street, Idaho|444-444-1212
```

要提取符合特定条件的行，请执行以下操作:

```
sqlite> select * from contacts where name="Mike Parks";
2|Mike Parks|10 Upping Street, Idaho|444-444-1212
```

要退出 sqlite3 交互环境:

```
sqlite> .exit
```

当在模拟器环境中运行安卓应用程序时，将使用前面讨论的路径约定在模拟器的文件系统上创建任何数据库文件。这样做的好处是，您可以与 adb 连接，导航到数据库文件的位置，将其加载到 sqlite3 交互工具中，并对数据执行任务，以识别应用程序代码中可能出现的问题。

还需要注意的是，虽然可以使用 adb shell 连接到物理 Android 设备，但默认情况下，该 shell 没有被授予足够的权限来创建和管理 SQLite 数据库。因此，数据库问题的调试最好使用 AVD 会话来执行。

65.9 安卓房间持久性库

如前所述，SQLite 是用 C 编程语言编写的，而 Android 应用程序主要是使用 Java 或 Kotlin 开发的。为了弥补过去的这种“语言鸿沟”，安卓软件开发工具包包含了一组类，这些类在 SQLite 数据库管理系统之上提供了一层。尽管在 SDK 中仍然可用，但是使用这些类仍然需要编写大量的代码，并且没有利用新的体系结构指南和特性，例如 LiveData 和生命周期管理。为了解决这些缺点，安卓喷气背包架构组件包括房间持久库。该库在 SQLite 数据库系统的基础上提供了一个高级接口，使得在安卓设备上以最少的编码本地存储数据变得容易，同时也符合现代应用架构的建议。

接下来的几章将提供使用 Room 持久性库的 SQLite 数据库管理的概述和教程。

65.10 总结

SQLite 是一个轻量级的嵌入式关系数据库管理系统，作为 Android 框架的一部分包含在内，并提供了一种机制来为 Android 应用程序实现有组织的持久数据存储。当与房间持久性库结合时，安卓提供了一种从安卓应用程序中实现数据存储的现代方式。

本章的目标是在安卓应用程序开发的背景下提供数据库的概述，特别是 SQLite。接下来的几章将概述 Room 持久性库，之后我们将创建一个示例应用程序。